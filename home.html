<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å - HEAD FACE</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gradient-to-br from-blue-100 to-blue-300 min-h-screen">
    <div class="bg-white shadow-md py-4 px-6 flex justify-between items-center">
      <h1 class="text-2xl font-bold text-blue-700">HEAD FACE 1.0</h1>
      <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-1 rounded-xl font-semibold">
        ‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏≠‡∏≤‡∏ó‡πå
      </button>
    </div>

    <div class="max-w-4xl mx-auto mt-4 px-4">
      <div class="bg-white rounded-2xl shadow-lg p-4 text-blue-800 font-semibold text-lg min-h-[60px]">
        <div id="typewriter"></div>
      </div>
    </div>

    <script>
      const messages = [
        "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Å‡πá‡∏™‡∏π‡πâ ‡πÜ ‡∏ô‡∏∞!",
        "‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏™‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏∞!",
        "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡πá‡∏û‡∏±‡∏Å ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡πà‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡∏ô‡∏∞",
        "‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ü‡∏£‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!",
        "‡∏ñ‡πâ‡∏≤‡∏ä‡∏≠‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ ‡πÅ‡∏ä‡∏£‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞ üòÑ",
        "‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏´‡∏°? ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!",
        "‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ HEAD FACE ‚ù§Ô∏è",
        "‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô!",
        "‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏´‡∏°‡∏ô‡∏∞? ‡∏Å‡∏î‡∏î‡∏π‡πÄ‡∏•‡∏¢!",
        "‡∏à‡∏≥‡πÑ‡∏ß‡πâ‡∏ß‡πà‡∏≤...‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÑ‡∏°‡πà‡∏™‡∏π‡∏ç‡πÄ‡∏õ‡∏•‡πà‡∏≤ ‚ú®"
      ];
      let currentMessage = 0;
      let charIndex = 0;
      const typeTarget = document.getElementById("typewriter");
      function typeWriter() {
        const message = messages[currentMessage];
        if (charIndex < message.length) {
          typeTarget.innerHTML += message.charAt(charIndex);
          charIndex++;
          setTimeout(typeWriter, 50);
        } else {
          setTimeout(() => {
            deleteMessage();
          }, 2500);
        }
      }
      function deleteMessage() {
        const message = messages[currentMessage];
        if (charIndex > 0) {
          typeTarget.innerHTML = message.substring(0, charIndex - 1);
          charIndex--;
          setTimeout(deleteMessage, 30);
        } else {
          currentMessage = (currentMessage + 1) % messages.length;
          setTimeout(typeWriter, 300);
        }
      }
      document.addEventListener("DOMContentLoaded", () => {
        typeWriter();
      });
    </script>

    <div class="max-w-4xl mx-auto mt-8 px-4">
      <div class="bg-white rounded-2xl shadow-xl p-6">
        <h2 class="text-xl font-bold text-blue-700 mb-4">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h2>
        <div id="user-info" class="mb-6 text-gray-700"></div>

        <h2 class="text-xl font-bold text-blue-700 mb-4">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</h2>
        <div id="hw-list" class="space-y-4"></div>

        <h2 class="text-xl font-bold text-blue-700 mb-4 mt-8">‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</h2>
        <div class="flex justify-between items-center mb-2">
          <button id="prev-month" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
          <div id="month-label" class="font-semibold text-blue-700"></div>
          <button id="next-month" class="bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
        <div id="calendar" class="grid grid-cols-7 gap-2 text-center text-sm text-gray-700"></div>
      </div>
    </div>

    <div id="loading" class="fixed inset-0 bg-white bg-opacity-80 flex items-center justify-center hidden z-50">
      <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-blue-500 border-solid"></div>
    </div>

    <script>
      const user = JSON.parse(localStorage.getItem("user"));
      const loading = document.getElementById("loading");
      let currentYear = new Date().getFullYear();
      let currentMonth = new Date().getMonth();
      let cachedHomework = [];

      async function fetchHomework(serverUpdated) {
        const url = `https://script.google.com/macros/s/AKfycbxQyMf_zMNuZoa_JLqa2S5LJYgxd1HwDfnMw-3_FtMH-mN2Db72O4xfqpU17zg2mebPkw/exec?action=hw&no=${user.no}`;
        const res = await fetch(url);
        const data = await res.json();
        if (data.status === "success") {
          localStorage.setItem("hw_data", JSON.stringify(data.homework));
          localStorage.setItem("last_updated", serverUpdated);
          cachedHomework = data.homework;
          renderHomework(data.homework);
          renderCalendar(currentYear, currentMonth, data.homework);
        }
      }

      function renderCalendar(year, month, homeworks) {
        const calendarEl = document.getElementById("calendar");
        calendarEl.innerHTML = "";
        const firstDay = new Date(year, month, 1);
        const startDay = firstDay.getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        document.getElementById("month-label").textContent = `${year} - ${month + 1}`;

        const hwMap = {};
        homeworks.forEach(hw => {
          const date = new Date(hw.due_date);
          if (date.getFullYear() === year && date.getMonth() === month) {
            const day = date.getDate();
            if (!hwMap[day]) hwMap[day] = [];
            hwMap[day].push(hw);
          }
        });

        const weekDays = ["‡∏≠‡∏≤", "‡∏à", "‡∏≠", "‡∏û", "‡∏û‡∏§", "‡∏®", "‡∏™"];
        weekDays.forEach(day => {
          const cell = document.createElement("div");
          cell.className = "font-bold text-blue-700";
          cell.textContent = day;
          calendarEl.appendChild(cell);
        });

        for (let i = 0; i < startDay; i++) {
          calendarEl.appendChild(document.createElement("div"));
        }

        for (let i = 1; i <= daysInMonth; i++) {
          const cell = document.createElement("div");
          cell.className = "border rounded-xl p-1 min-h-[40px] flex flex-col items-center justify-start bg-white";
          const dateLabel = document.createElement("div");
          dateLabel.textContent = i;
          dateLabel.className = "text-xs font-semibold";
          cell.appendChild(dateLabel);
          if (hwMap[i]) {
            hwMap[i].forEach(hw => {
              const badge = document.createElement("div");
              badge.className = "mt-1 px-1 py-0.5 bg-yellow-200 text-xs text-blue-700 rounded";
              badge.textContent = hw.subject;
              cell.appendChild(badge);
            });
          }
          calendarEl.appendChild(cell);
        }
      }

      document.getElementById("prev-month").addEventListener("click", () => {
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
        renderCalendar(currentYear, currentMonth, cachedHomework);
      });

      document.getElementById("next-month").addEventListener("click", () => {
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        renderCalendar(currentYear, currentMonth, cachedHomework);
      });

      function renderHomework(homeworks) {
        const list = document.getElementById("hw-list");
        if (!homeworks.length) {
          list.innerHTML = "<p class='text-gray-500'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô</p>";
          return;
        }
        let html = "";
        homeworks.forEach(hw => {
          html += `<div class='bg-white rounded-xl shadow p-4'><h3 class='font-semibold text-blue-700'>${hw.subject}</h3><p>${hw.title}</p><p>‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏á: ${hw.due_date}</p></div>`;
        });
        list.innerHTML = html;
      }

      async function checkLastUpdatedAndLoad() {
        loading.classList.remove("hidden");
        try {
          const res = await fetch("https://script.google.com/macros/s/AKfycbxQyMf_zMNuZoa_JLqa2S5LJYgxd1HwDfnMw-3_FtMH-mN2Db72O4xfqpU17zg2mebPkw/exec?action=lastUpdated");
          const data = await res.json();
          const serverUpdated = data.last_updated;
          const localUpdated = localStorage.getItem("last_updated");
          const localHW = localStorage.getItem("hw_data");
          if (localUpdated === serverUpdated && localHW) {
            cachedHomework = JSON.parse(localHW);
            renderHomework(cachedHomework);
            renderCalendar(currentYear, currentMonth, cachedHomework);
          } else {
            await fetchHomework(serverUpdated);
          }
        } catch (err) {
          alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
        } finally {
          loading.classList.add("hidden");
        }
      }

      if (!user) {
        window.location.href = "index.html";
      } else {
        document.getElementById("user-info").innerHTML = `<p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${user.firstName} ${user.lastName}</p><p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</strong> ${user.no}</p><p><strong>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß:</strong> ${user.studentId}</p>`;
        checkLastUpdatedAndLoad();
      }

      document.getElementById("logout-btn").addEventListener("click", () => {
        localStorage.clear();
        window.location.href = "index.html";
      });
    </script>
  </body>
</html>
